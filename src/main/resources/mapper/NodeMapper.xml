<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.saas.platform.mapper.NodeMapper">

    <!-- 节点分页查询 -->
    <select id="selectNodePage" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL
        <if test="nodeName != null and nodeName != ''">
            AND node_name LIKE CONCAT('%', #{nodeName}, '%')
        </if>
        <if test="country != null and country != ''">
            AND country = #{country}
        </if>
        <if test="nodeType != null and nodeType != ''">
            AND node_type = #{nodeType}
        </if>
        <if test="nodeStatus != null and nodeStatus != ''">
            AND node_status = #{nodeStatus}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 根据节点编码查询 -->
    <select id="selectByNodeCode" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL AND node_code = #{nodeCode}
    </select>

    <!-- 根据服务器IP查询 -->
    <select id="selectByServerIp" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL AND server_ip = #{serverIp}
    </select>

    <!-- 查询运行中的节点 -->
    <select id="selectRunningNodes" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL AND node_status = '运行中'
        ORDER BY created_at DESC
    </select>

    <!-- 按国家查询节点 -->
    <select id="selectByCountry" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL AND country = #{country}
        ORDER BY created_at DESC
    </select>

    <!-- 查询需要检查的节点 -->
    <select id="selectNeedCheckNodes" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL 
        AND (last_check_time IS NULL OR last_check_time &lt; DATE_SUB(NOW(), INTERVAL #{hours} HOUR))
        ORDER BY last_check_time ASC
    </select>

    <!-- 批量更新节点状态 -->
    <update id="batchUpdateStatus">
        UPDATE nodes 
        SET node_status = #{status}, updated_at = NOW()
        WHERE id IN 
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted_at IS NULL
    </update>

    <!-- 更新节点监控数据 -->
    <update id="updateMonitorData">
        UPDATE nodes 
        SET 
            current_connections = #{currentConnections},
            cpu_usage = #{cpuUsage},
            memory_usage = #{memoryUsage},
            disk_usage = #{diskUsage},
            network_latency = #{networkLatency},
            last_check_time = NOW(),
            updated_at = NOW()
        WHERE id = #{nodeId} AND deleted_at IS NULL
    </update>

    <!-- 统计各状态节点数量 -->
    <select id="countByStatus" resultType="java.util.HashMap">
        SELECT 
            node_status as status,
            COUNT(*) as count
        FROM nodes 
        WHERE deleted_at IS NULL
        GROUP BY node_status
    </select>

    <!-- 按国家统计节点数量 -->
    <select id="countByCountry" resultType="java.util.HashMap">
        SELECT 
            country,
            COUNT(*) as count
        FROM nodes 
        WHERE deleted_at IS NULL
        GROUP BY country
        ORDER BY count DESC
    </select>

    <!-- 按节点类型统计数量 -->
    <select id="countByType" resultType="java.util.HashMap">
        SELECT 
            node_type as type,
            COUNT(*) as count
        FROM nodes 
        WHERE deleted_at IS NULL
        GROUP BY node_type
    </select>

    <!-- 查询高负载节点 -->
    <select id="selectHighLoadNodes" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL 
        AND node_status = '运行中'
        AND (cpu_usage &gt; #{cpuThreshold} OR memory_usage &gt; #{memoryThreshold})
        ORDER BY cpu_usage DESC, memory_usage DESC
    </select>

    <!-- 查询连接数接近上限的节点 -->
    <select id="selectHighConnectionNodes" resultType="com.saas.platform.entity.Node">
        SELECT 
            id, node_name, node_code, server_ip, username, country, region,
            ssh_port, password, domain, node_type, combination_type, 
            remark, agent_status, node_status, max_connections, 
            current_connections, bandwidth_mbps, cpu_usage, memory_usage, 
            disk_usage, network_latency, last_check_time, provider, 
            monthly_cost, created_at, updated_at, deleted_at
        FROM nodes 
        WHERE deleted_at IS NULL 
        AND node_status = '运行中'
        AND max_connections > 0
        AND (current_connections * 100 / max_connections) &gt;= #{threshold}
        ORDER BY (current_connections * 100 / max_connections) DESC
    </select>

    <!-- 统计节点总成本 -->
    <select id="sumMonthlyCost" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(monthly_cost), 0) 
        FROM nodes 
        WHERE deleted_at IS NULL
    </select>

</mapper>